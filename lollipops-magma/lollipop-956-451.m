clear;

D:=40201986;
x:=589042076226215548287689476330582191609793749744861871604900539741454676076257591997245318667180479210398140701841229910422936321486475345296314; 
assert x mod 12 eq 10;
p:=x^2-x+1;
q:=x^2+1;
assert IsPrime(p: Proof:=false);
assert IsPrime(q: Proof:=false);
Fp:=GF(p);
Fq:=GF(q);

////////////////////////////////////////////////////////////
//Construct Ecalhat
////////////////////////////////////////////////////////////
Fq3:=ExtensionField<Fq,x|IrreduciblePolynomial(Fq,3)>;
Ecalhat:=BaseChange(EllipticCurve([Fq|0,1]),Fq3);
assert #Ecalhat eq (q^3+1);
assert (q^3+1) mod p eq 0;

////////////////////////////////////////////////////////////
//Construct Ecal
////////////////////////////////////////////////////////////
Fp2<mu>:=ExtensionField<Fp,x|x^2+1>;
alpha:=mu+1;
Ecal:=EllipticCurve([Fp2|alpha,0]);
assert #Ecal eq (p^2+1);
assert (p^2+1) mod q eq 0;

////////////////////////////////////////////////////////////
//Construct E
////////////////////////////////////////////////////////////

//jp is a root of Hilbert Class Polynomial H_D(X) in Fp[X]
//jp:=303387350602502852986319421629165475401446262001068991436770909935013222010906086320730338233202393706820747782347708070120052981544555026260645273875871761641623095609954474371957243716959045159421870757163502191854664197932001623376240123586659249642472017777625508275961279215754002605;
//Ep:=QuadraticTwist(EllipticCurveFromjInvariant(Fp!jp));
a:=327109485262376726136172643805932252878964212240064991046803990546570692113955204504295853421320565971168014448160518214189382593729022922934619191479697131508401422054977766988346990626462981083698419529403033388974770759484439350971607246476622466769281101195803851961334206387433757192;
b:=279050255428736347835787201657572365478299307911044416076073175912778177975625581983202449094627882457913470267629624709093466687587530683922179493820089554667794629254883792790600467080376496365458891552310274342079659991659178694655626276630944082371547597372703391340583858884507859049;
E:=EllipticCurve([Fp|a,b]);
h:=76182347360104295691389198837779736649246768246453788622413701157110735036917351906437908803769129014598039561668077363397378012546375286033150471993610;
r:=4554474620279221025376588013428792331658085875800439965576470444142136125074436360422816311318800204172284882642774195680976231192452677;
assert IsPrime(r: Proof:=false);
N:=h*r;
assert N*Random(E) eq E!0;
assert Evaluate(CyclotomicPolynomial(4),p) mod r eq 0; 

////////////////////////////////////////////////////////////
//Construct Ebold and Eboldhat: D=-56731
////////////////////////////////////////////////////////////
Fr:=GF(r);
rhat:=4554474620279221025376588013428792331658085875800439965576470444142127975354138524998341010887945287609636101034245310800998935953876811;
Frhat:=GF(rhat);
abold:=690575014239454026638313273329796547820393408742460126354768053643684518773934884666730883558156028900268187865564024445057072912921515;
bbold:=2931206434669286082400888631663293346675485377851507931593738296428532456121222430361182020448147882192902114775558386761455466572805157;
Ebold:=EllipticCurve([Fr|abold,bbold]);
aboldhat:=1972836130617312264884522886607377588737124874558355128915486743894639213792715792469391602871306903957933707088190344635368569493105706;
bboldhat:=667467996430158755384029725741044737402793847049612710548493018355905138502964590739405943223201736357580147915836335807698999577229546;
Eboldhat:=EllipticCurve([Frhat|aboldhat,bboldhat]);
assert rhat*Random(Ebold) eq Ebold!0;
assert r*Random(Eboldhat) eq Eboldhat!0;

////////////////////////////////////////////////////////////
//Construct Ebold_W
////////////////////////////////////////////////////////////
b:=146441;
Ebold_W:=EllipticCurve([Fr|-3,b]);
N_W:=4554474620279221025376588013428792331658085875800439965576470444142137012790331503296048511068375852301852166502782404804129551442423273;
Ebold_Wt:=QuadraticTwist(Ebold_W);
N_Wt:=4554474620279221025376588013428792331658085875800439965576470444142135237358541217549584111569224556042717598782765986557822910942482083;
assert IsPrime(N_W: Proof:=false);
assert IsPrime(N_Wt: Proof:=false);
assert N_W*Random(Ebold_W) eq Ebold_W!0;
assert N_Wt*Random(Ebold_Wt) eq Ebold_Wt!0;

////////////////////////////////////////////////////////////
//Construct Ebold_Ed
////////////////////////////////////////////////////////////
d:=104359;
AS<X,Y>:=AffineSpace(Fr,2);
Ebold_Ed:=Curve(AS,-X^2+Y^2-(1+d*X^2*Y^2));
E_Ed:=EllipticCurve(ProjectiveClosure(Ebold_Ed),Ebold_Ed![0,1]);
r_Ed:=569309327534902628172073501678599041457260734475054995697058805517765479097142202181635379290879602240595939629855820268382212105985899;
E_Edt:=QuadraticTwist(E_Ed);
r_Edt:=1138618655069805256344147003357198082914521468950109991394117611035537104342933775848137397077640897604950562061675457303723691384254541;
assert IsPrime(r_Ed: Proof:=false);
assert IsPrime(r_Edt: Proof:=false);
N_Ed:=2^3*r_Ed;
N_Edt:=2^2*r_Edt;
assert N_Ed*Random(E_Ed) eq E_Ed!0;
assert N_Edt*Random(E_Edt) eq E_Edt!0;

